# advanced-api-gateway-resources
Cloud Academy - Advanced API Gateway
https://cloudacademy.com/course/advanced-use-of-amazon-api-gateway/creating-dynamodb-table-and-lambda-functions/

Description
Amazon API Gateway allows you to design RESTful interfaces and connect them to your favorite backend. You can design your own resources structure, add dynamic routing parameters, and develop custom authorizations logic. Each API resource can be configured independently, while each stage can have specific cache, throttling, and logging configurations.

This approach is particularly useful when you consider that each request and response can be attached to a custom mapping template, in order to perform custom data manipulation or improve API backward compatibility.

Description
In this course, we will create a multi-tier serverless architecture on AWS using Amazon API Gateway, AWS Lambda, AWS Step Functions, and Amazon Polly text to speech. This is a hands-on course where you will learn how to create serverless functions, data access, business logic, and integration layers on AWS. Also, you will learn how to create a presentation layer for your application using the client SDK generated by Amazon API Gateway. We will then host the application on Amazon S3.

Learning Objectives
By the end of this course, you will be able to recognize and implement an end to end workflow built in the Amazon Cloud using Serverless components.

Intended Audience
This course is intended for developers or DevOps engineers who want to create serverless applications on AWS, or who may be considering migrating their existing web applications to AWS.

Prerequisites
A basic familiarity with Amazon API Gateway, Lambda, DynamoDb, S3, and AWS Step functions is required for this course. Some knowledge of building web applications using HTML and JavaScript will also be helpful.

Resources
The GitHub repository for this course is available here: https://github.com/cloudacademy/advanced-api-gateway-resources.

Transcript
Hello and welcome back. In this lecture, we'll create the data and data access layers for our application, which will consist of DynamoDB and Lambda functions. Let's look at our application workflow before we head to create the Lambda functions. In our application, the user will select Menu Items, Delivery Options and a Payment Type, and then submit the order. Once the order is submitted, the payment will be processed, and either approved or rejected. Based on that, the order will be further processed or canceled, and the user will be notified accordingly. This workflow can be easily translated into Step Functions or a State Machine, and we'll see that in the next video. For now, we can just think of each step in the workflow as a Lambda function which does a discreet task, and passes the results to the next function. To start, we'll first need to create a table in DynamoDB to which our Lambda functions will write to and re-prompt. I'll go to our DynamoDB console and create a table, let's call it Orders. I'll choose Order ID as a primary key. We don't need to do anything else here since it's a NoSQL Database, and we can insert our records later through the Lambda function in the format we like. We'll create our Lambda functions using a CloudFormation template. But before that, I would need to place my code on S3 so that the CloudFormation template can access it. Let's create a bucket in S3 and call it gopizza-lamba-functions. All of the Lambda functions are in .js files, and I'll zip them all up as Lambda Functions.zip and upload to the bucket. From here, the CloudFormation template can access the code. Okay, now here is my CloudFormation template that I've already created using YAML. This template creates a role which our Lambda functions will use. It has a AssumeRolePolicyDocument property, which is a trust policy associated with this role, which will allow Lambda functions to assume its role. It also has these ManagePolicyArns that give it full access to S3, DynamoDB and Amazon Polly, as required by our Lambda functions. Then we create our five Lambda functions through the template. If you look at the first Lambda function, PlaceOrder, it has the type of Lambda function, and properties including description, function name, a handler, which is the function Lambda will invoke, and since we've saved our Node.js function as PlaceOrder.js, the handler will be PlaceOrder.handler. For role, we'll get the ARN of the role created earlier in the template. For code, we'll specify the S3 Bucket where our code is located, and the name of the ZIP file which contains all the functions. So, I'll go to CloudFormation Console and execute the template to create our functions in us-east-2 region. If you plan to use Step Functions, make sure you choose a region where it support it. The template also creates an IAM role, so I'll need to acknowledge that, and then click on create. Our stack is successfully created, now let's look at each Lambda function to understand it's functionality. The first function to be executed is PlaceOrder. This function simply puts all the data from the input event, including Order Type, Menu Items, and Payment Details to the Orders table in DynamoDB and passes over the information to the next Lambda function in the workflow which is ProcessPayment. ProcessPayment is just a stub method here, with some hard-coded logic for demo. It only passes the payment if credit card number is all ones, all the others are rejected. In the real world, of course, this method would be much sophisticated to correctly process the payment details. This function returns two objects, one is a paymentSuccess boolean value, and the other is the Params from the event. The paymentSuccess variable allows us to determine whether the order was successfully placed or canceled, and will be used in the choice state later in the State Machine. After that we have two more functions, ConfirmOrder and CancelOrder. Both update the order status of the record, where they confirm or cancel the value, based on the paymentSuccess value. After that we have NotifyUser function, which just returns the order status in text format. And the last function, NotifyWithPolly, converts the text order status to speech in the form of MP3 file, and stores it on S3 for the front-end page to playback so the user can hear the order status in live-like speech format from our front-end app. Okay, now we have all our Lambda functions in place, so it's time to put them in the correct order of execution. We'll do that using the step functions in our next video.

About the Author

Tehreem Siddiqui

Sr. Software Engineer

Tehreem is a Sr. Software Engineer with passion in Cloud Technologies, Big Data analytics, Software Testing and Automation. She has over 10 years of work experience comprising of her tenure at ServiceNow, Microsoft and Harmonic Inc. Most recently she has been developing learning content in-line with the emergence of Public Clouds and XaaS platforms with focus on AWS, Microsoft Azure and GCP. Tehreem resides in BayArea, CA with her family and when not working she enjoys nature/outdoors, movies and fine dining.

![after image](https://assets.cloudacademy.com/bakery/media/uploads/laboratories/environment_start_images/before_L6y0zJY.png)
![after iamge](https://assets.cloudacademy.com/bakery/media/uploads/laboratories/environment_end_images/After_kkGvc81.png)

Amazon API Gateway allows you to design RESTful interfaces and connect them to your favorite backend. You can design your own resources structure, add dynamic routing parameters, and develop custom authorizations logic. Each API resource can be configured independently, while each stage can have specific cache, throttling, and logging configurations.

This approach is particularly useful when you consider that each request and response can be attached to a custom mapping template, in order to perform custom data manipulation or improve API backward compatibility.

In this Lab, you will see how to define a simple API and how to connect it to AWS Lambda. This provides a nice way to obtain a scalable backend for modern web applications or mobile apps. You will configure custom stages, protect resources with an API key, and explain how to best connect API Gateway stages with AWS Lambda versions and aliases. You will learn about AWS Lambda's basic configuration, monitoring, and versioning as you progress through the Lab.

Lab Objectives
Upon completion of this Lab, you will be able to:

Understand the basics of RESTful APIs
Implement REST APIs using Amazon API Gateway
Enable desirable API features in API Gateway including caching, throttling, CORS, usage plans, and API key access
Create serverless API backends using AWS Lambda functions
Implement best practices for integrating Lambda backends in API Gateway
Lab Prerequisites
You should be familiar with:

Serverless computing fundamentals, particularly AWS Lambda, is beneficial
Prior experience using or implementing REST APIs is beneficial, but not required
Updates
January 22nd, 2021 - Updated AWS Lambda lab step to reflect latest user interface changes

July 21st, 2020 - Updated lab security policy to prevent the appearance of a DescribeVpcEndpoints error pop-up while creating the REST API

January 10th, 2019 - Added a validation Lab Step to check the work you perform in the Lab

September 5, 2018 - Improved Lab instructions format and clarity. Updated instructions and screenshots to match the new API Gateway interface

https://cloudacademy.com/lab/restful-microservices-aws-lambda-api-gateway/?context_resource=lp&context_id=241

Getting Started in a Browser Script
PDF
RSS
JavaScript code example that applies to browser execution

This browser script example shows you:

How to access AWS services from a browser script using Amazon Cognito Identity.

How to turn text into synthesized speech using Amazon Polly.

How to use a presigner object to create a presigned URL.

The Scenario
Amazon Polly is a cloud service that converts text into lifelike speech. You can use Amazon Polly to develop applications that increase engagement and accessibility. Amazon Polly supports multiple languages and includes a variety of lifelike voices. For more information about Amazon Polly, see the Amazon Polly Developer Guide.

The example shows how to set up and run a simple browser script that takes text you enter, sends that text to Amazon Polly, and then returns the URL of the synthesized audio of the text for you to play. The browser script uses Amazon Cognito Identity to provide credentials needed to access AWS services. You will see the basic patterns for loading and using the SDK for JavaScript in browser scripts.

![polly](https://docs.amazonaws.cn/en_us/sdk-for-javascript/v2/developer-guide/images/browserscenario.png)

The browser script uses the SDK for JavaScript to synthesize text by using these APIs:

AWS.CognitoIdentityCredentials constructor

AWS.Polly.Presigner constructor

getSynthesizeSpeechUrl

Step 1: Create an Amazon Cognito Identity Pool
In this exercise, you create and use an Amazon Cognito identity pool to provide unauthenticated access to your browser script for the Amazon Polly service. Creating an identity pool also creates two IAM roles, one to support users authenticated by an identity provider and the other to support unauthenticated guest users.

In this exercise, we will only work with the unauthenticated user role to keep the task focused. You can integrate support for an identity provider and authenticated users later.

To create an Amazon Cognito identity pool

Sign in to the AWS Management Console and open the Amazon Cognito console at https://console.aws.amazon.com/cognito/.

Choose Manage Identity Pools on the console opening page.

On the next page, choose Create new identity pool.

Note
If there are no other identity pools, the Amazon Cognito console will skip this page and open the next page instead.

In the Getting started wizard, type a name for your identity pool in Identity pool name.

Choose Enable access to unauthenticated identities.

Choose Create Pool.

On the next page, choose View Details to see the names of the two IAM roles created for your identity pool. Make a note of the name of the role for unauthenticated identities. You need this name to add the required policy for Amazon Polly.

Choose Allow.

On the Sample code page, select the Platform of JavaScript. Then, copy or write down the identity pool ID and the Region. You need these values to replace REGION and IDENTITY_POOL_ID in your browser script.

After you create your Amazon Cognito identity pool, you're ready to add permissions for Amazon Polly that are needed by your browser script.

Step 2: Add a Policy to the Created IAM Role
To enable browser script access to Amazon Polly for speech synthesis, use the unauthenticated IAM role created for your Amazon Cognito identity pool. This requires you to add an IAM policy to the role. For more information on IAM roles, see Creating a Role to Delegate Permissions to an AWS Service in the IAM User Guide.

To add an Amazon Polly policy to the IAM role associated with unauthenticated users

Sign in to the AWS Management Console and open the IAM console at https://console.amazonaws.cn/iam/.

In the navigation panel on the left of the page, choose Roles.

In the list of IAM roles, click on the link for the unauthenticated identities role previously created by Amazon Cognito.

In the Summary page for this role, choose Attach policies.

In the Attach Permissions page for this role, find and then select the check box for AmazonPollyFullAccess.

Note
You can use this process to enable access to any Amazon or AWS service.

Choose Attach policy.

After you create your Amazon Cognito identity pool and add permissions for Amazon Polly to your IAM role for unauthenticated users, you are ready to build the webpage and browser script.

Step 3: Create the HTML Page
The sample app consists of a single HTML page that contains the user interface and browser script. To begin, create an HTML document and copy the following contents into it. The page includes an input field and button, an <audio> element to play the synthesized speech, and a <p> element to display messages. (Note that the full example is shown at the bottom of this page.)

For more information on the <audio> element, see audio.

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>AWS SDK for JavaScript - Browser Getting Started Application</title>
  </head>

  <body>
    <div id="textToSynth">
      <input autofocus size="23" type="text" id="textEntry" value="It's very good to meet you."/>
      <button class="btn default" onClick="speakText()">Synthesize</button>
      <p id="result">Enter text above then click Synthesize</p>
    </div>
    <audio id="audioPlayback" controls>
      <source id="audioSource" type="audio/mp3" src="">
    </audio>
    <!-- (script elements go here) -->
 </body>
</html>
Save the HTML file, naming it polly.html. After you have created the user interface for the application, you're ready to add the browser script code that runs the application.

Step 4: Write the Browser Script
The first thing to do when creating the browser script is to include the SDK for JavaScript by adding a <script> element after the <audio> element in the page:

<script src="https://sdk.amazonaws.com/js/aws-sdk-SDK_VERSION_NUMBER.min.js"></script>
(To find the current SDK_VERSION_NUMBER, see the API Reference for the SDK for JavaScript at https://docs.aws.amazon.com/AWSJavaScriptSDK/latest/index.html.)

Then add a new <script type="text/javascript"> element after the SDK entry. You'll add the browser script to this element. Set the AWS Region and credentials for the SDK. Next, create a function named speakText() that will be invoked as an event handler by the button.

To synthesize speech with Amazon Polly, you must provide a variety of parameters including the sound format of the output, the sampling rate, the ID of the voice to use, and the text to play back. When you initially create the parameters, set the Text: parameter to an empty string; the Text: parameter will be set to the value you retrieve from the <input> element in the webpage.

    <script type="text/javascript">

        // Initialize the Amazon Cognito credentials provider
        AWS.config.region = 'REGION'; 
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId: 'IDENTITY_POOL_ID'});
        
        // Function invoked by button click
        function speakText() {
            // Create the JSON parameters for getSynthesizeSpeechUrl
            var speechParams = {
                OutputFormat: "mp3",
                SampleRate: "16000",
                Text: "",
                TextType: "text",
                VoiceId: "Matthew"
            };
            speechParams.Text = document.getElementById("textEntry").value;
Amazon Polly returns synthesized speech as an audio stream. The easiest way to play that audio in a browser is to have Amazon Polly make the audio available at a presigned URL you can then set as the src attribute of the <audio> element in the webpage.

Create a new AWS.Polly service object. Then create the AWS.Polly.Presigner object you'll use to create the presigned URL from which the synthesized speech audio can be retrieved. You must pass the speech parameters that you defined as well as the AWS.Polly service object that you created to the AWS.Polly.Presigner constructor.

After you create the presigner object, call the getSynthesizeSpeechUrl method of that object, passing the speech parameters. If successful, this method returns the URL of the synthesized speech, which you then assign to the <audio> element for playback.

            // Create the Polly service object and presigner object
            var polly = new AWS.Polly({apiVersion: '2016-06-10'});
            var signer = new AWS.Polly.Presigner(speechParams, polly)
        
            // Create presigned URL of synthesized speech file
            signer.getSynthesizeSpeechUrl(speechParams, function(error, url) {
            if (error) {
                document.getElementById('result').innerHTML = error;
            } else {
                document.getElementById('audioSource').src = url;
                document.getElementById('audioPlayback').load();
                document.getElementById('result').innerHTML = "Speech ready to play.";
            }
          });
        }
    </script>
Step 5: Run the Sample
To run the sample app, load polly.html into a web browser. This is what the browser presentation should resemble.


                        Web application browser interface
                    
Enter a phrase you want turned to speech in the input box, then choose Synthesize. When the audio is ready to play, a message appears. Use the audio player controls to hear the synthesized speech.

Full Sample
Here is the full HTML page with the browser script. It's also available here on GitHub.

<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>AWS SDK for JavaScript - Browser Getting Started Application</title>
  </head>

  <body>
    <div id="textToSynth">
      <input autofocus size="23" type="text" id="textEntry" value="It's very good to meet you."/>
      <button class="btn default" onClick="speakText()">Synthesize</button>
      <p id="result">Enter text above then click Synthesize</p>
    </div>
    <audio id="audioPlayback" controls>
      <source id="audioSource" type="audio/mp3" src="">
    </audio>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.410.0.min.js"></script>
    <script type="text/javascript">

        // Initialize the Amazon Cognito credentials provider
        AWS.config.region = 'REGION'; 
        AWS.config.credentials = new AWS.CognitoIdentityCredentials({IdentityPoolId: 'IDENTITY_POOL_ID'});
        
        // Function invoked by button click
        function speakText() {
            // Create the JSON parameters for getSynthesizeSpeechUrl
            var speechParams = {
                OutputFormat: "mp3",
                SampleRate: "16000",
                Text: "",
                TextType: "text",
                VoiceId: "Matthew"
            };
            speechParams.Text = document.getElementById("textEntry").value;
            
            // Create the Polly service object and presigner object
            var polly = new AWS.Polly({apiVersion: '2016-06-10'});
            var signer = new AWS.Polly.Presigner(speechParams, polly)
        
            // Create presigned URL of synthesized speech file
            signer.getSynthesizeSpeechUrl(speechParams, function(error, url) {
            if (error) {
                document.getElementById('result').innerHTML = error;
            } else {
                document.getElementById('audioSource').src = url;
                document.getElementById('audioPlayback').load();
                document.getElementById('result').innerHTML = "Speech ready to play.";
            }
          });
        }
    </script>
  </body>
</html>
Possible Enhancements
Here are variations on this application you can use to further explore using the SDK for JavaScript in a browser script.

Experiment with other sound output formats.

Add the option to select any of the various voices provided by Amazon Polly.

Integrate an identity provider like Facebook or Amazon to use with the authenticated IAM role.
https://docs.amazonaws.cn/en_us/sdk-for-javascript/v2/developer-guide/getting-started-browser.html



